<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Fantasy Auction Draft Tracker</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Bootstrap (for quick layout) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <!-- React + ReactDOM (UMD build) -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <!-- PapaParse for CSV parsing -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body { padding: 1rem; background:#f8f9fa; }
    .player-row { cursor:pointer; }
    .drafted { text-decoration: line-through; opacity:0.5;}
    .team-card { min-width:160px; }
    .small-input { width:80px; display:inline-block; }
    @media (max-width:700px) { .team-card { min-width:140px; } }
  </style>
</head>
<body>
  <div id="root"></div>

<script>
const e = React.createElement;
const { useState, useEffect, useRef } = React;

const STORAGE_KEY = 'auction_draft_tracker_v1';

function defaultState() {
  return {
    teams: Array.from({length:10}, (_,i) => ({id:i, name: 'Team ' + (i+1), budget:200, spent:0})),
    players: [], // {name, pos, team, rank, draftedBy: teamId|null, cost:null}
    draftOrder: [], // order of team ids
    currentPickIndex: 0,
    scoring: 'PPR', // or 'STD'
  }
}

function saveState(state) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}
function loadState() {
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw) return defaultState();
  try { return JSON.parse(raw); } catch(e){ return defaultState(); }
}

function App(){
  const [state, setState] = useState(loadState);
  useEffect(()=> saveState(state), [state]);

  // Import CSV and map columns (we expect FantasyPros cheat-sheet CSV layout)
  function handleCSV(file) {
    if(!file) return;
    Papa.parse(file, {
      header: true,
      skipEmptyLines: true,
      complete: (res) => {
        const rows = res.data;
        // Attempt to map common FantasyPros headers
        // Typical columns: Player, Team, Pos, Rank, Bye
        const players = rows.map((r, idx) => {
          const name = r.Player || r['Player/Team'] || r['PLAYER'] || r.player || '';
          // sometimes "Player (TEAM)" - attempt to split
          let team = r.Team || r['Team'] || '';
          let pos = (r.Pos || r['POS'] || '').toUpperCase() || '';
          // rank or overall
          const rank = Number(r.Rk || r.Rank || r['Overall'] || r['Rank'] || (idx+1)) || (idx+1);
          return {
            id: idx,
            name: (''+name).trim(),
            pos: pos || detectPosFromRow(r),
            team: (''+team).trim(),
            rank: rank,
            draftedBy: null,
            cost: null
          };
        }).filter(p => p.name);
        // sort by rank ascending
        players.sort((a,b)=> (a.rank||9999) - (b.rank||9999));
        setState(prev => ({...prev, players}));
      }
    });
  }

  function detectPosFromRow(r){
    const p = (r.Pos || r.Position || '').toUpperCase();
    if(p) return p;
    // fallback: check Player string for RB/WR/QB/TE
    const pn = (r.Player||'').toUpperCase();
    if(pn.includes('QB')) return 'QB';
    if(pn.includes('RB')) return 'RB';
    if(pn.includes('WR')) return 'WR';
    if(pn.includes('TE')) return 'TE';
    return 'N/A';
  }

  function resetAll() { if(!confirm('Reset app state?')) return; const s=defaultState(); setState(s); }

  function updateTeamName(id,name){
    setState(s => ({...s, teams: s.teams.map(t=> t.id===id?{...t,name}:t)}));
  }

  function randomizeDraftOrder(){
    const ids = state.teams.map(t=>t.id);
    for(let i=ids.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [ids[i], ids[j]] = [ids[j], ids[i]];
    }
    setState(s => ({...s, draftOrder: ids, currentPickIndex:0}));
  }

  function assignPlayerToTeam(playerId, teamId, cost){
    setState(s => {
      const teams = s.teams.map(t => {
        if(t.id===teamId){
          const spent = Number(t.spent || 0) + Number(cost || 0);
          return {...t, spent, budget: Number((200 - spent).toFixed(2))};
        }
        return t;
      });
      const players = s.players.map(p => p.id===playerId ? {...p, draftedBy: teamId, cost: Number(cost)} : p);
      return {...s, players, teams};
    });
  }

  function undoDraft(playerId){
    setState(s=>{
      const players = s.players.map(p => {
        if(p.id===playerId && p.draftedBy!=null){
          const teamId = p.draftedBy;
          const cost = p.cost || 0;
          const teams = s.teams.map(t => t.id===teamId ? {...t, spent: Number((t.spent - cost).toFixed(2)), budget: Number((200 - (t.spent - cost)).toFixed(2))} : t);
          return {...p, draftedBy:null, cost:null, teams};
        }
        return p;
      });
      // players map above can't update teams globally; do a two-step approach
      // we'll instead compute teams separately
      let teams = s.teams.slice();
      const p = s.players.find(x=>x.id===playerId);
      if(p && p.draftedBy!=null){
        const teamId = p.draftedBy;
        teams = teams.map(t => t.id===teamId ? {...t, spent: Number((t.spent - (p.cost||0)).toFixed(2)), budget: Number((200 - (t.spent - (p.cost||0))).toFixed(2))} : t);
      }
      const players2 = s.players.map(p2 => p2.id===playerId ? {...p2, draftedBy:null, cost:null} : p2);
      return {...s, players: players2, teams};
    });
  }

  function manualAdjustTeamSpent(teamId, newSpent){
    setState(s=>{
      const teams = s.teams.map(t => t.id===teamId ? {...t, spent: Number(newSpent), budget: Number((200 - newSpent).toFixed(2))} : t);
      return {...s, teams};
    });
  }

  function toggleScoring(mode){
    setState(s => ({...s, scoring: mode}));
  }

  return e('div', {className:'container'},
    e('div', {className:'d-flex justify-content-between align-items-center mb-3'},
      e('h3', null, 'Auction Draft Tracker'),
      e('div', null,
        e('button',{className:'btn btn-outline-secondary me-2', onClick:resetAll}, 'Reset'),
        e('button',{className:'btn btn-sm btn-outline-primary', onClick: ()=>{ localStorage.removeItem(STORAGE_KEY); location.reload(); }}, 'Clear Storage')
      )
    ),

    e('div',{className:'row mb-3'},
      e('div',{className:'col-md-6 mb-2'},
        e('div',{className:'card p-3'},
          e('h5', null, 'Import FantasyPros Rankings (CSV)'),
          e('p', {className:'small text-muted'}, 'Download a cheat-sheet CSV from FantasyPros (PPR or Standard) and import it here.'),
          e('input',{type:'file', accept:'.csv', onChange: (ev)=> handleCSV(ev.target.files[0])}),
          e('div',{className:'mt-2'},
            e('label', null, 'Scoring: '),
            e('select',{value: state.scoring, onChange: (e)=> toggleScoring(e.target.value)}, [
              e('option',{key:'PPR', value:'PPR'}, 'PPR'),
              e('option',{key:'STD', value:'STD'}, 'Standard'),
              e('option',{key:'HALF', value:'HALF'}, 'Half PPR')
            ])
          ),
          e('p', {className:'mt-2 small text-muted'}, 'Note: players marked drafted will be removed from remaining lists. Rankings order comes from the CSV.')
        )
      ),
      e('div',{className:'col-md-6 mb-2'},
        e('div',{className:'card p-3'},
          e('h5', null, 'Teams & Budgets'),
          e('div', {className:'d-flex flex-wrap gap-2'},
            state.teams.map(t =>
              e('div',{key:t.id, className:'card p-2 team-card'},
                e('div', {className:'mb-1'},
                  e('input', {value:t.name, onChange: (ev)=> updateTeamName(t.id, ev.target.value), className:'form-control form-control-sm'})
                ),
                e('div', null, e('small', null, `Spent: $${Number(t.spent).toFixed(2)}`)),
                e('div', null, e('small', null, `Left: $${Number(t.budget).toFixed(2)}`)),
                e('div',{className:'mt-1'},
                  e('input',{type:'number', min:0, step:0.5, placeholder:'Set Spent', className:'form-control form-control-sm', onBlur: (ev)=> { const v = Number(ev.target.value||0); manualAdjustTeamSpent(t.id, v); }} )
                )
              )
            )
          )
        )
      )
    ),

    e('div',{className:'row mb-3'},
      e('div',{className:'col-md-6'},
        e('div',{className:'card p-3'},
          e('h5', null, 'Draft order (draw from hat)'),
          e('div', null,
            e('button',{className:'btn btn-primary me-2', onClick: randomizeDraftOrder}, 'Draw Teams (Randomize)'),
            e('span',{className:'ms-2 small text-muted'}, 'Current pick index: ' + state.currentPickIndex)
          ),
          e('div',{className:'mt-2 small'},
            (state.draftOrder.length ? state.draftOrder.map((tid, idx)=> {
              const t = state.teams.find(x=>x.id===tid);
              const cls = idx===state.currentPickIndex ? 'fw-bold text-success' : '';
              return e('div',{key:tid, className: cls}, `${idx+1}. ${t ? t.name : 'Team'}`);
            }) : e('div', null, 'No draft order set yet.'))
          )
        )
      ),
      e('div',{className:'col-md-6'},
        e('div',{className:'card p-3'},
          e('h5', null, 'Remaining top players by position'),
          e('div',{className:'d-flex gap-2 mb-2'},
            e(AvailablePlayersPanel, {players: state.players, teams: state.teams, onAssign: assignPlayerToTeam, onUndo: undoDraft})
          )
        )
      )
    ),

    e('div',{className:'row'},
      e('div',{className:'col-md-8'},
        e('div',{className:'card p-3 mb-3'},
          e('h5', null, 'Full player list (click to assign)'),
          e('table',{className:'table table-sm'},
            e('thead', null,
              e('tr', null,
                e('th', null, 'Rank'),
                e('th', null, 'Player'),
                e('th', null, 'Pos'),
                e('th', null, 'Team'),
                e('th', null, 'Drafted'),
                e('th', null, 'Actions')
              )
            ),
            e('tbody', null,
              state.players.map(p =>
                e('tr',{key:p.id, className: 'player-row ' + (p.draftedBy!=null? 'drafted':'' )},
                  e('td', null, p.rank),
                  e('td', null, p.name),
                  e('td', null, p.pos),
                  e('td', null, p.team),
                  e('td', null, p.draftedBy!=null ? `${ state.teams.find(t=>t.id===p.draftedBy)?.name } $${Number(p.cost).toFixed(2)}` : 'Available'),
                  e('td', null,
                    p.draftedBy==null ?
                      e(AssignPanel, {teams: state.teams, playerId: p.id, onAssign: assignPlayerToTeam}) :
                      e('button',{className:'btn btn-sm btn-outline-danger', onClick: ()=> undoDraft(p.id)}, 'Undo')
                  )
                )
              )
            )
          )
        )
      ),
      e('div',{className:'col-md-4'},
        e('div',{className:'card p-3 mb-3'},
          e('h5', null, 'Quick team summary'),
          state.teams.map(t => 
            e('div',{key:t.id, className:'mb-2'},
              e('div', {className:'d-flex justify-content-between'},
                e('strong', null, t.name),
                e('span', null, `$${Number(t.budget).toFixed(2)} left`)
              ),
              e('div', null, e('small', null, `Spent: $${Number(t.spent).toFixed(2)}`))
            )
          )
        ),
        e('div',{className:'card p-3'},
          e('h5', null, 'Save / Share'),
          e('p', {className:'small'}, 'Your draft state is saved locally in your browser. To share manually: export localStorage via browser devtools or use the CSV import on another device.')
        )
      )
    )
  );
}

// Component: panel to show filtered remaining players and quick assign
function AvailablePlayersPanel({players, teams, onAssign, onUndo}){
  const [posFilter, setPosFilter] = useState('ALL');
  const [topN, setTopN] = useState(10);
  const positions = ['ALL', 'QB','RB','WR','TE','K','DEF','N/A'];

  const available = players.filter(p=> p.draftedBy==null && (posFilter==='ALL' || p.pos===posFilter)).slice(0, topN);

  return e('div', null,
    e('div',{className:'d-flex mb-2 gap-2'},
      e('select',{value:posFilter, onChange: e=> setPosFilter(e.target.value), className:'form-select form-select-sm w-auto'}, positions.map(x=> e('option',{key:x, value:x}, x))),
      e('input',{type:'number', value: topN, onChange: e=> setTopN(Number(e.target.value||0)), className:'form-control form-control-sm w-auto', min:1})
    ),
    e('ul',{className:'list-group small', style:{maxHeight:250, overflow:'auto'}},
      available.map(p => 
        e('li',{key:p.id, className:'list-group-item d-flex justify-content-between align-items-start'},
          e('div', null, e('strong', null, `${p.rank}. ${p.name}`), e('div', {className:'small text-muted'}, `${p.pos} â€¢ ${p.team}`)),
          e('div', null, e(AssignPanel, {teams, playerId: p.id, onAssign}))
        )
      )
    )
  );
}

// Component: small assignment panel (choose team + cost)
function AssignPanel({teams, playerId, onAssign}) {
  const [team, setTeam] = useState(teams[0]?.id ?? 0);
  const [cost, setCost] = useState(1);
  return e('div', {className:'d-flex gap-1 align-items-center'},
    e('select',{className:'form-select form-select-sm', style:{width:120}, value:team, onChange:e=> setTeam(Number(e.target.value))},
      teams.map(t=> e('option',{key:t.id, value:t.id}, t.name))
    ),
    e('input',{type:'number', className:'form-control form-control-sm small-input', value:cost, min:0, step:0.5, onChange: e=> setCost(e.target.value)}),
    e('button',{className:'btn btn-sm btn-success', onClick: ()=> onAssign(playerId, Number(team), Number(cost))}, 'Assign')
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(e(App));
</script>
</body>
</html>
